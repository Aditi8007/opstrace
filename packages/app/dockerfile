FROM debian:stable-slim
RUN apt-get update && apt-get install -y -q --no-install-recommends curl git ca-certificates moreutils openssl

# - Install NodeJS via nvm, analogue to local dev setup
ENV NODE_VERSION v14.15.0
ENV NVM_DIR /nvm
RUN mkdir $NVM_DIR && git clone https://github.com/nvm-sh/nvm.git "${NVM_DIR}"
RUN cd "${NVM_DIR}" && git checkout v0.37.0
RUN . "${NVM_DIR}"/nvm.sh && nvm install "${NODE_VERSION}"

# Put `node` and `npm` into PATH, for subsequent RUN statements but also for
# all commands later on run in the container.
ENV NODE_PATH=$NVM_DIR/versions/node/$NODE_VERSION/lib/node_modules
ENV PATH=$NVM_DIR/versions/node/$NODE_VERSION/bin:/bin:$PATH

RUN npm install -g yarn
RUN curl -L https://github.com/hasura/graphql-engine/raw/stable/cli/get.sh | INSTALL_PATH=/bin bash

# Make build log have explicit confirmation of versions in use.
RUN node --version
RUN yarn --version

WORKDIR /usr/src/opstrace/packages/app

EXPOSE 3000
EXPOSE 3001
EXPOSE 9695

# check hasura install
RUN hasura -h